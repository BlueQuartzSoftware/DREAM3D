#!/bin/bash
# This script requires a single argument which is the current install path

DEBUG=0
# -----------------------------------------------------------------------------
#  Conditional Printing
# -----------------------------------------------------------------------------
function printStatus()
{
	if [ "x$DEBUG" = "x1" ]; then
	    echo "${1}"
	fi	
}



InstallPrefix="${1}"
ProjectBinaryDir=@PROJECT_INSTALL_DIR@
# ProjectBinaryDir="${InstallPrefix}/@osx_app_name@.app"
OSX_App_Name="@osx_app_name@"
OSX_App="@CMAKE_RUNTIME_OUTPUT_DIRECTORY@/@osx_app_name@.app"
arch=@CMAKE_OSX_ARCHITECTURES@
logFile=/tmp/ThinAndShareLibraries.log

# Create the shared frameworks directory
mkdir -p ${InstallPrefix}/Frameworks
cd ${InstallPrefix}/${ProjectBinaryDir}/Contents/Frameworks
frameworks=`find . -type d -name "*.framework"`
for f in ${frameworks}
do
  cd ${InstallPrefix}/${ProjectBinaryDir}/Contents/Frameworks
  if [ ! -d "${InstallPrefix}/Frameworks/$f" ]; then
    printStatus "Moving $f to external shared frameworks directory"
    mv $f ${InstallPrefix}/Frameworks/.
  else
    rm -rf "${InstallPrefix}/${ProjectBinaryDir}/Contents/Frameworks/$f"
  fi
  
  printStatus "Creating Symlink to external Shared Frameworks directory for $f"
  ln -s ${InstallPrefix}/Frameworks/$f .

  printStatus "Thinning Framework to arch $arch"
  cd ${InstallPrefix}/Frameworks/$f
  base=`basename -s .framework $f`
  file=`find . -type f -name "$base"`
  lipo $file -thin $arch -output $file  > ${logFile} 2> ${logFile}

done


# Now create the 'lib' shared directory
mkdir -p ${InstallPrefix}/lib
cd ${InstallPrefix}/${ProjectBinaryDir}/Contents/lib
frameworks=`find . -type f -name "*.dylib"`
for f in ${frameworks}
do
  cd ${InstallPrefix}/${ProjectBinaryDir}/Contents/lib
  if [ ! -f ${InstallPrefix}/lib/$f ]; then
    printStatus "Moving $f to external shared lib directory"
    mv $f ${InstallPrefix}/lib/.
  else
    rm $f
  fi

  printStatus "Creating Symlink to external Shared lib directory for $f"
  ln -s ${InstallPrefix}/lib/$f .
  
  printStatus "Thinning dylib to arch $arch"
  
  lipo ${InstallPrefix}/lib/$f -thin $arch -output ${InstallPrefix}/lib/$f > ${logFile} 2> ${logFile}
  
  
done

rm ${logFile}
